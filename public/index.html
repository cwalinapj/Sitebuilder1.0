<!doctype html>
<html>
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Site Builder</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap");
    :root {
      --bg: #f5f8fb;
      --panel-bg: #ffffff;
      --panel-border: #dbe4ef;
      --text: #162434;
      --muted: #5e748d;
      --accent: #1276d1;
      --accent-ink: #ffffff;
      --ai-bubble: #eef5fb;
      --me-bubble: #e8f7ef;
      --btn-bg: #f3f7fb;
      --btn-border: #ccd9e8;
    }
    body[data-theme="classic"] {
      --bg: #f6f8f7;
      --panel-bg: #ffffff;
      --panel-border: #d5e0d8;
      --text: #1c2b22;
      --muted: #5d7163;
      --accent: #0f7a3f;
      --accent-ink: #ffffff;
      --ai-bubble: #edf5ef;
      --me-bubble: #e6f5ec;
      --btn-bg: #f4f8f6;
      --btn-border: #c8d7cd;
    }
    body[data-theme="web3"] {
      --bg: #0b0e14;
      --panel-bg: #0f1520;
      --panel-border: #23314a;
      --text: #e6edf8;
      --muted: #95a7c3;
      --accent: #00d3a7;
      --accent-ink: #03110e;
      --ai-bubble: #141f2f;
      --me-bubble: #122723;
      --btn-bg: #101c2a;
      --btn-border: #254163;
    }
    body {
      font-family: "Plus Jakarta Sans", "Avenir Next", "Segoe UI", sans-serif;
      max-width: 920px;
      margin: 24px auto;
      padding: 0 12px;
      color: var(--text);
      background:
        radial-gradient(circle at top right, #ddeeff 0%, rgba(221,238,255,0) 35%),
        radial-gradient(circle at bottom left, #dcf6e8 0%, rgba(220,246,232,0) 35%),
        var(--bg);
    }
    body[data-theme="web3"] {
      background:
        radial-gradient(circle at top right, rgba(60, 116, 255, 0.24) 0%, rgba(17,22,35,0) 40%),
        radial-gradient(circle at bottom left, rgba(0, 211, 167, 0.2) 0%, rgba(8,11,18,0) 40%),
        linear-gradient(180deg, #090d15, #0a1018 45%, #0b0f16);
    }
    body[data-theme="classic"] {
      background:
        radial-gradient(circle at top right, #e7f4ea 0%, rgba(231,244,234,0) 35%),
        radial-gradient(circle at bottom left, #eef6ff 0%, rgba(238,246,255,0) 35%),
        var(--bg);
    }
    .topRibbon {
      display: grid;
      grid-template-columns: auto 1fr;
      align-items: center;
      gap: 14px;
      margin: 6px 0 16px;
      background: rgba(255, 255, 255, 0.9);
      border: 1px solid #d5e2ef;
      border-radius: 16px;
      padding: 10px 12px;
      box-shadow: 0 18px 34px rgba(18, 44, 75, 0.08);
    }
    body[data-theme="web3"] .topRibbon {
      background: rgba(14, 22, 36, 0.88);
      border-color: #2a3d5d;
      box-shadow: 0 22px 40px rgba(2, 10, 24, 0.48);
      backdrop-filter: blur(8px);
    }
    body[data-theme="classic"] .topRibbon {
      border-radius: 12px;
      box-shadow: 0 10px 24px rgba(29, 56, 41, 0.08);
    }
    .brand {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .brandLogo {
      width: 42px;
      height: 42px;
      border-radius: 12px;
      border: 1px solid #bfd2e6;
      background: linear-gradient(145deg, #f9fcff, #e5f0fb);
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.85), 0 8px 18px rgba(25, 67, 111, 0.18);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    body[data-theme="web3"] .brandLogo {
      border-color: #39598a;
      background: linear-gradient(145deg, #12243b, #0e1a2a);
      box-shadow: inset 0 1px 0 rgba(186, 216, 255, 0.12), 0 10px 20px rgba(0, 0, 0, 0.5);
    }
    body[data-theme="classic"] .brandLogo {
      border-radius: 10px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.9), 0 6px 12px rgba(24, 73, 43, 0.1);
    }
    .brandLogo svg {
      width: 24px;
      height: 24px;
      display: block;
    }
    .brandText {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .brandName {
      font-size: 18px;
      font-weight: 800;
      letter-spacing: 0.04em;
      color: #153657;
      text-transform: uppercase;
    }
    body[data-theme="web3"] .brandName {
      color: #dfe8fb;
      letter-spacing: 0.08em;
    }
    body[data-theme="classic"] .brandName {
      color: #21412d;
    }
    .brandSub {
      font-size: 11px;
      color: #5a7491;
      letter-spacing: 0.02em;
      margin-top: 2px;
    }
    body[data-theme="web3"] .brandSub {
      color: #9cb2d3;
    }
    body[data-theme="classic"] .brandSub {
      color: #5e7668;
    }
    .ribbonRight {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 8px;
      flex-wrap: wrap;
    }
    .ribbonCaption {
      font-size: 11px;
      color: #617f9d;
      font-weight: 600;
      letter-spacing: 0.03em;
      margin-right: 4px;
      line-height: 1.3;
    }
    .frameworkBadge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 8px;
      border-radius: 999px;
      border: 1px solid #c6d3e0;
      background: #ffffff;
      font-size: 11px;
      color: #193655;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      font-weight: 700;
    }
    body[data-theme="web3"] .frameworkBadge {
      border-color: #2d4669;
      background: #101c2c;
      color: #c9daf6;
    }
    body[data-theme="classic"] .frameworkBadge {
      border-radius: 12px;
      text-transform: none;
      letter-spacing: 0.02em;
      font-weight: 600;
      color: #2e4a39;
      border-color: #c8d9cd;
      background: #f8fbf8;
    }
    .themePill {
      display: inline-flex;
      align-items: center;
      padding: 6px 10px;
      border: 1px solid var(--btn-border);
      border-radius: 999px;
      background: var(--btn-bg);
      color: var(--muted);
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .frameworkBadge img {
      width: 16px;
      height: 16px;
    }
    @media (max-width: 720px) {
      .topRibbon {
        grid-template-columns: 1fr;
        gap: 10px;
      }
      .ribbonRight {
        justify-content: center;
      }
      .brand {
        justify-content: center;
      }
      .brandSub {
        text-align: center;
      }
      .ribbonCaption {
        margin-right: 0;
      }
    }
    #chat {
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 14px;
      height: 65vh;
      overflow: auto;
      background: var(--panel-bg);
      box-shadow: 0 12px 30px rgba(21, 44, 75, 0.08);
      margin: 0 auto;
    }
    body[data-theme="web3"] #chat {
      box-shadow: 0 14px 28px rgba(0, 0, 0, 0.42);
    }
    body[data-theme="classic"] #chat {
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(32, 60, 40, 0.1);
    }
    .msg { margin: 10px 0; white-space: pre-wrap; line-height: 1.35; }
    .ai { color: var(--text); }
    .me { color: #0e6a3c; text-align: right; }
    .bubble {
      display: inline-block;
      padding: 10px 12px;
      border-radius: 12px;
      max-width: 92%;
      border: 1px solid var(--panel-border);
    }
    .ai .bubble { background: var(--ai-bubble); }
    .me .bubble { background: var(--me-bubble); }
    a { color: #0e5ea8; text-decoration: underline; }
    form { display:flex; gap:8px; margin-top: 10px; }
    input { flex:1; padding: 12px; border-radius: 10px; border:1px solid var(--btn-border); }
    button { padding: 12px 14px; border-radius: 10px; border:1px solid var(--btn-border); background: var(--btn-bg); cursor:pointer; }
    button:disabled { opacity: 0.5; cursor:not-allowed; }

    #quickBar { display:none; gap:10px; margin-top: 10px; }
    .qr { flex:1; padding: 12px 14px; border-radius: 10px; border:1px solid var(--btn-border); background:#fff; cursor:pointer; }
    .qr.primary { background: var(--accent); color: var(--accent-ink); border-color: var(--accent); }
    #smartBar { display:none; gap:8px; margin-top: 8px; flex-wrap:wrap; }
    .smartBtn { padding:9px 11px; border-radius: 999px; border:1px solid var(--btn-border); background:#fff; color: var(--text); cursor:pointer; font-size: 13px; }
    .smartBtn:hover { border-color: #9cb4ce; }
    #actionBar { display:none; gap:8px; margin-top:10px; flex-wrap:wrap; }
    .actionBtn { padding:10px 12px; border-radius:10px; border:1px solid #2d4d71; background:#fff; color:#163454; cursor:pointer; }
    .actionBtn.primary { background:#173b62; color:#fff; }
    .ctaRow { margin-top: 10px; display:flex; gap:8px; flex-wrap:wrap; }
    .ctaBtn { display:inline-block; padding:10px 12px; border-radius:10px; border:1px solid #2d4d71; text-decoration:none; color:#163454; background:#fff; font-size:14px; }
    .ctaBtn.primary { background:#173b62; color:#fff; }
    .paletteRow {
      margin-top: 10px;
      display: grid;
      gap: 12px;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    }
    .paletteCard {
      border: 1px solid #cfdeee;
      border-radius: 14px;
      background: linear-gradient(180deg, #ffffff, #f7fbff);
      padding: 11px;
      box-shadow: 0 8px 22px rgba(20, 53, 86, 0.08);
      transition: transform 0.14s ease, box-shadow 0.14s ease, border-color 0.14s ease;
    }
    .paletteCard:hover {
      transform: translateY(-2px);
      border-color: #9bb6d4;
      box-shadow: 0 12px 26px rgba(20, 53, 86, 0.14);
    }
    .paletteMeta {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 6px;
    }
    .paletteTag {
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #1d4f81;
      border: 1px solid #b8cbe0;
      border-radius: 999px;
      padding: 3px 8px;
      background: #edf4fb;
    }
    .paletteTitle {
      font-size: 14px;
      font-weight: 700;
      margin-bottom: 4px;
      color: #173b62;
      line-height: 1.2;
    }
    .paletteHint {
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 8px;
      min-height: 30px;
    }
    .palettePreview {
      width: 100%;
      height: 34px;
      border-radius: 10px;
      border: 1px solid #bdd0e5;
      margin-bottom: 8px;
      background: linear-gradient(90deg, #f1f5f9, #dbe8f4);
    }
    .paletteSwatches {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 9px;
    }
    .paletteSwatch {
      border-radius: 9px;
      overflow: hidden;
      border: 1px solid #a3b7cc;
      background: #fff;
    }
    .paletteDot {
      width: 100%;
      height: 30px;
      border: 0;
      border-radius: 0;
    }
    .paletteHex {
      display: block;
      font-size: 10px;
      line-height: 1;
      text-align: center;
      padding: 5px 3px;
      color: #304f70;
      background: #fff;
      letter-spacing: 0.02em;
    }
    .palettePickBtn {
      width: 100%;
      padding: 9px 10px;
      border-radius: 10px;
      border: 1px solid #9eb7d1;
      background: linear-gradient(180deg, #fafdff, #edf4fb);
      cursor: pointer;
      font-size: 12px;
      font-weight: 700;
      color: #173b62;
      transition: border-color 0.14s ease, box-shadow 0.14s ease, transform 0.14s ease;
    }
    .palettePickBtn:hover {
      border-color: #5f85ab;
      box-shadow: 0 6px 14px rgba(28, 68, 110, 0.16);
      transform: translateY(-1px);
    }
    .palettePickBtn:disabled {
      opacity: 0.62;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    #startPanel {
      border: 1px solid #cdddf0;
      border-radius: 14px;
      background:
        linear-gradient(180deg, rgba(255,255,255,0.98), rgba(245,250,255,0.98));
      padding: 14px;
      margin-bottom: 10px;
      box-shadow: 0 8px 24px rgba(24, 49, 80, 0.08);
    }
    body[data-theme="web3"] #startPanel {
      border-color: #2a3e5f;
      background: linear-gradient(180deg, rgba(16,24,38,0.95), rgba(12,18,29,0.95));
      box-shadow: 0 14px 26px rgba(0, 0, 0, 0.38);
    }
    body[data-theme="classic"] #startPanel {
      border-radius: 12px;
      border-color: #cfddcf;
      box-shadow: 0 8px 18px rgba(33, 64, 45, 0.08);
    }
    .startTitle {
      font-size: 15px;
      font-weight: 700;
      color: #153350;
      text-align: center;
      letter-spacing: 0.02em;
    }
    body[data-theme="web3"] .startTitle { color: #d8e5fb; }
    body[data-theme="classic"] .startTitle { color: #1e3e2a; }
    .startSub {
      margin-top: 4px;
      color: var(--muted);
      font-size: 13px;
      text-align: center;
    }
    .startRow {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 8px;
      margin-top: 10px;
    }
    .startBtn {
      padding: 10px 11px;
      border-radius: 10px;
      border: 1px solid var(--btn-border);
      background: #fff;
      cursor: pointer;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: flex-start;
      text-align: left;
      transition: transform 0.12s ease, box-shadow 0.12s ease, border-color 0.12s ease;
    }
    .startBtn:hover {
      transform: translateY(-1px);
      border-color: #8aabd0;
      box-shadow: 0 8px 18px rgba(35, 70, 110, 0.12);
    }
    .startBtn.primary {
      background: #173b62;
      color: #fff;
      border-color: #173b62;
    }
    body[data-theme="web3"] .startBtn.primary {
      background: linear-gradient(180deg, #18cfa8, #08a585);
      color: #03130f;
      border-color: #1ed8b2;
    }
    body[data-theme="classic"] .startBtn.primary {
      background: #118848;
      border-color: #118848;
      color: #fff;
    }
    .startIconWrap {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: #eff5fb;
      border: 1px solid #c8d9ec;
      flex: 0 0 20px;
    }
    .startBtn.primary .startIconWrap {
      background: rgba(255, 255, 255, 0.18);
      border-color: rgba(255, 255, 255, 0.35);
      color: #fff;
    }
    .startIcon {
      width: 16px;
      height: 16px;
      border-radius: 4px;
      display: block;
    }
    .startLabel {
      line-height: 1.1;
      font-weight: 600;
      letter-spacing: 0.1px;
    }
    .startHint {
      margin-top: 8px;
      color: var(--muted);
      font-size: 13px;
    }
    #billingPanel {
      margin-top: 12px;
      border: 1px solid #cdddf0;
      border-radius: 12px;
      padding: 10px 12px;
      background: #f7fbff;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.6);
    }
    .billingTitle {
      font-size: 13px;
      font-weight: 700;
      color: #153350;
      margin-bottom: 4px;
    }
    .billingLine {
      font-size: 12px;
      color: var(--muted);
      margin-top: 2px;
      line-height: 1.35;
    }
    .billingActions {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .billingToggle {
      background: none;
      border: none;
      color: #0e5ea8;
      cursor: pointer;
      padding: 0;
      font-size: 12px;
      text-decoration: underline;
    }
    .billingDetails {
      margin-top: 6px;
      padding: 8px 10px;
      background: #eef5fb;
      border-radius: 10px;
      border: 1px solid #d4e1ef;
      display: none;
    }
    .billingDetails ul {
      margin: 6px 0 0 16px;
      padding: 0;
    }
    .trustStrip {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
    }
    .trustChip {
      border: 1px solid #c8d7e8;
      border-radius: 999px;
      padding: 4px 8px;
      background: #fff;
      font-weight: 600;
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }
    .privacyBlock {
      margin-top: 8px;
      font-size: 11px;
      color: var(--muted);
    }
    .billingBtn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #2d4d71;
      background: #fff;
      color: #163454;
      font-size: 12px;
      text-decoration: none;
    }
    .billingBtn.primary {
      background: #173b62;
      color: #fff;
    }
    @media (max-width: 560px) {
      .startRow { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <div class="topRibbon">
    <div class="brand">
      <div class="brandLogo" aria-hidden="true">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M14 19.5C14 16.5 16.5 14 19.5 14H44.5C47.5 14 50 16.5 50 19.5V44.5C50 47.5 47.5 50 44.5 50H19.5C16.5 50 14 47.5 14 44.5V19.5Z" fill="#173B62"/>
          <path d="M22 24H42V30H28V34H40V40H28V44H22V24Z" fill="#EFF6FD"/>
          <path d="M43 24H49V44H43V24Z" fill="#7FB0E1"/>
        </svg>
      </div>
      <div class="brandText">
        <div class="brandName">Site Builder</div>
        <div class="brandSub">Build-ready websites with guided AI workflow</div>
      </div>
    </div>
    <div class="ribbonRight">
      <div class="themePill" id="themePill">Theme: Auto</div>
      <div class="ribbonCaption">Supported frameworks</div>
      <div class="frameworkBadge">
        <img src="https://www.google.com/s2/favicons?sz=64&domain_url=nextjs.org" alt="Next.js"/>
        Next.js
      </div>
      <div class="frameworkBadge">
        <img src="https://www.google.com/s2/favicons?sz=64&domain_url=astro.build" alt="Astro"/>
        Astro
      </div>
      <div class="frameworkBadge">
        <img src="https://www.google.com/s2/favicons?sz=64&domain_url=react.dev" alt="React"/>
        React
      </div>
      <div class="frameworkBadge">
        <img src="https://www.google.com/s2/favicons?sz=64&domain_url=tailwindcss.com" alt="Tailwind"/>
        Tailwind
      </div>
    </div>
  </div>
  <div id="startPanel">
    <div class="startTitle" id="startTitle">Sign in with wallet (no transaction)</div>
    <div class="startSub" id="startSub">This signs a message to prove ownership. It does not move funds.</div>
    <div class="startRow">
      <button class="startBtn primary" id="startNameBtn" type="button">
        <span class="startIconWrap" aria-hidden="true">N</span>
        <span class="startLabel">Use Name</span>
      </button>
      <button class="startBtn" id="walletMetaMaskBtn" type="button">
        <span class="startIconWrap"><img class="startIcon" src="https://www.google.com/s2/favicons?sz=64&domain_url=metamask.io" alt="MetaMask icon"/></span>
        <span class="startLabel">MetaMask</span>
      </button>
      <button class="startBtn" id="walletConnectBtn" type="button">
        <span class="startIconWrap"><img class="startIcon" src="https://www.google.com/s2/favicons?sz=64&domain_url=walletconnect.com" alt="WalletConnect icon"/></span>
        <span class="startLabel">WalletConnect</span>
      </button>
      <button class="startBtn" id="walletLedgerBtn" type="button">
        <span class="startIconWrap"><img class="startIcon" src="https://www.google.com/s2/favicons?sz=64&domain_url=ledger.com" alt="Ledger icon"/></span>
        <span class="startLabel">Ledger</span>
      </button>
      <button class="startBtn" id="walletPhantomBtn" type="button">
        <span class="startIconWrap"><img class="startIcon" src="https://www.google.com/s2/favicons?sz=64&domain_url=phantom.app" alt="Phantom icon"/></span>
        <span class="startLabel">Phantom</span>
      </button>
    </div>
    <div class="startHint" id="startHint">No approvals. No gas. Disconnect anytime. Transactions are only for top-ups.</div>
    <div class="trustStrip" aria-label="Wallet trust indicators">
      <div class="trustChip">Never share seed phrase</div>
      <div class="trustChip">No approvals</div>
      <div class="trustChip">No gas</div>
      <div class="trustChip">Disconnect anytime</div>
    </div>
    <div id="billingPanel" style="display:none;">
      <div class="billingTitle">Balances and pricing</div>
      <div class="billingLine" id="billingStarter">Loading starter balance...</div>
      <div class="billingLine" id="billingPricing"></div>
      <div class="billingLine" id="billingBalance" style="display:none;"></div>
      <div class="billingActions" id="billingActions" style="display:none;"></div>
    </div>
  </div>
  <div id="chat"></div>

  <div id="quickBar">
    <button class="qr primary" id="btnYes" type="button">Yes</button>
    <button class="qr" id="btnNo" type="button">No</button>
  </div>
  <div id="smartBar"></div>
  <div id="actionBar"></div>

  <form id="form">
    <input id="input" placeholder="Type here..." autocomplete="off" disabled/>
    <button type="submit" id="sendBtn" disabled>Send</button>
  </form>
  <div class="privacyBlock">
    We store wallet address, build history (stack, palette, copy), and point totals. We never store seed phrases or private keys.
  </div>
  <div id="turnstileMount" style="display:none;"></div>

  <script>
    const PRIMARY_WORKER_BASE = "https://api.cardetailingreno.com";
    const FALLBACK_WORKER_BASE = "https://sitebuilder-agent.96psxbzqk2.workers.dev";
    let sessionId = null;
    let state = null;

    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const form = document.getElementById("form");
    const startPanel = document.getElementById("startPanel");
    const startTitle = document.getElementById("startTitle");
    const startSub = document.getElementById("startSub");
    const startHint = document.getElementById("startHint");
    const startNameBtn = document.getElementById("startNameBtn");
    const walletMetaMaskBtn = document.getElementById("walletMetaMaskBtn");
    const walletConnectBtn = document.getElementById("walletConnectBtn");
    const walletLedgerBtn = document.getElementById("walletLedgerBtn");
    const walletPhantomBtn = document.getElementById("walletPhantomBtn");
    const quickBar = document.getElementById("quickBar");
    const smartBar = document.getElementById("smartBar");
    const actionBar = document.getElementById("actionBar");
    const btnYes = document.getElementById("btnYes");
    const btnNo = document.getElementById("btnNo");
    const sendBtn = document.getElementById("sendBtn");
    const billingPanel = document.getElementById("billingPanel");
    const billingStarter = document.getElementById("billingStarter");
    const billingPricing = document.getElementById("billingPricing");
    const billingBalance = document.getElementById("billingBalance");
    const billingActions = document.getElementById("billingActions");
    const themePill = document.getElementById("themePill");
    let autoAdvanceTimer = null;
    let pendingRequest = false;
    let walletSession = null;
    let onchainClaimShown = false;
    let securityConfig = {
      turnstile_required: false,
      turnstile_site_key: null,
      wallet_login_enabled: true,
      walletconnect_project_id: null,
    };
    let turnstileScriptPromise = null;
    let walletConnectScriptPromise = null;
    let walletConnectProvider = null;
    let turnstileWidgetId = null;
    let turnstileResolve = null;
    let turnstileReject = null;
    let currentThemeMode = "classic";
    function tollTokenLabel() {
      return "Toll Tokens";
    }

    function detectWalletExtensionPresence() {
      const eth = window.ethereum;
      const providers = Array.isArray(eth?.providers) ? eth.providers : [];
      const hasEvm = Boolean(eth || providers.length || window.phantom?.ethereum);
      const hasSolana = Boolean(window.phantom?.solana || window.solana?.isPhantom || window.solflare?.isSolflare);
      return hasEvm || hasSolana;
    }

    function setThemeCopy(theme) {
      if (!startTitle || !startSub || !startHint) return;
      if (theme === "web3") {
        startTitle.textContent = "Wallet-first mode (no transaction to sign in)";
        startSub.textContent = "Web3 extension detected. Message-sign only for login.";
        startHint.textContent = "No approvals. No gas to sign in. Transactions are only for top-ups.";
        return;
      }
      startTitle.textContent = "Choose how you want to sign in";
      startSub.textContent = "Classic mode for broad audiences. Wallet sign-in stays optional.";
      startHint.textContent = "No approvals. No gas. Disconnect anytime. Transactions are only for top-ups.";
    }

    function applyTheme(theme, source = "auto") {
      const mode = theme === "web3" ? "web3" : "classic";
      currentThemeMode = mode;
      document.body.setAttribute("data-theme", mode);
      setThemeCopy(mode);
      if (themePill) {
        const sourceLabel = source === "query" ? "manual" : source;
        themePill.textContent = `Theme: ${mode} (${sourceLabel})`;
      }
    }

    function resolveInitialTheme() {
      const q = new URLSearchParams(window.location.search).get("theme");
      if (q === "web3" || q === "classic") {
        applyTheme(q, "query");
        return;
      }
      const detected = detectWalletExtensionPresence();
      applyTheme(detected ? "web3" : "classic", "auto");

      if (!detected) {
        let checks = 0;
        const timer = setInterval(() => {
          checks += 1;
          if (detectWalletExtensionPresence()) {
            applyTheme("web3", "auto");
            clearInterval(timer);
            return;
          }
          if (checks >= 6) clearInterval(timer);
        }, 600);
      }
    }

    async function workerFetch(path, options = {}) {
      const primaryUrl = `${PRIMARY_WORKER_BASE}${path}`;
      let primaryResponse = null;
      try {
        primaryResponse = await fetch(primaryUrl, options);
      } catch {}

      const shouldFallback =
        !primaryResponse ||
        [520, 521, 522, 523, 525, 526, 530].includes(primaryResponse.status);

      if (!shouldFallback) return primaryResponse;
      return fetch(`${FALLBACK_WORKER_BASE}${path}`, options);
    }

    function formatPricingSummary(model, symbol = "Toll Tokens") {
      if (!model) return "";
      const base = Number(model.base_tokens || 0);
      const perPage = Number(model.per_page_tokens || 0);
      const perWords = Number(model.per_30_words_tokens || 0);
      const perComplex = Number(model.per_complexity_unit_tokens || 0);
      const est = Math.max(1, Math.round(base + perPage + (perWords * 10) + perComplex));
      return `Estimated cost: ~${est} ${symbol}. Includes 1 page, ~300 words, standard complexity.`;
    }

    function formatPricingDetails(model, symbol = "Toll Tokens") {
      if (!model) return "";
      const base = Number(model.base_tokens || 0);
      const perPage = Number(model.per_page_tokens || 0);
      const perWords = Number(model.per_30_words_tokens || 0);
      const perComplex = Number(model.per_complexity_unit_tokens || 0);
      const ex1 = Math.max(1, Math.round(base + perPage + perComplex));
      const ex2 = Math.max(1, Math.round(base + (2 * perPage) + (perWords * 12) + (2 * perComplex)));
      const ex3 = Math.max(1, Math.round(base + (3 * perPage) + (perWords * 20) + (3 * perComplex)));
      return {
        breakdown: [
          `Base ${base}`,
          `${perPage}/page`,
          `${perWords} per 30 words`,
          `${perComplex} per complexity unit`,
        ],
        examples: [
          `Simple landing page: ${ex1}-${ex1 + perPage} ${symbol}`,
          `With sections + FAQ: ${ex2}-${ex2 + perPage} ${symbol}`,
          `With lots of copy + components: ${ex3}-${ex3 + perPage} ${symbol}`,
        ],
      };
    }

    function setBillingActions(urls = []) {
      if (!billingActions) return;
      billingActions.innerHTML = "";
      const valid = urls.filter((u) => typeof u === "string" && u.trim());
      if (!valid.length) {
        billingActions.style.display = "none";
        return;
      }
      billingActions.style.display = "flex";
      valid.forEach((url, idx) => {
        const a = document.createElement("a");
        a.className = "billingBtn" + (idx === 0 ? " primary" : "");
        a.href = url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.textContent = idx === 0 ? "Top up Toll Tokens" : "Buy PTS points";
        billingActions.appendChild(a);
      });
    }

    function renderBillingConfig(cfg) {
      if (!billingPanel || !billingStarter || !billingPricing) return;
      const spl = tollTokenLabel();
      const freeTokens = Number(cfg?.free_tokens || 0);
      const freePoints = Number(cfg?.free_points || 0);
      const pointsSymbol = String(cfg?.points_symbol || "PTS");
      const pointsEnabled = cfg?.points_enabled === true;
      const llmBackend = String(cfg?.llm_backend || "external");
      const gpuBilling = cfg?.gpu_billing_enabled === true;
      const gpuEndpointRaw = String(cfg?.gpu_endpoint || "").trim();
      let gpuEndpoint = "";
      if (gpuEndpointRaw) {
        try {
          const u = new URL(gpuEndpointRaw);
          gpuEndpoint = u.hostname || gpuEndpointRaw;
        } catch {
          gpuEndpoint = gpuEndpointRaw.split("/")[0] || gpuEndpointRaw;
        }
      }
      const starterParts = [];
      starterParts.push(`On-chain ${spl}: ${freeTokens} (wallet balance).`);
      if (pointsEnabled) starterParts.push(`${pointsSymbol} Points: ${freePoints} (internal).`);
      starterParts.push(`Toll Tokens are on-chain utility. PTS is internal and non-transferable.`);
      if (gpuEndpoint) starterParts.push(`GPU backend: ${gpuBilling ? "on" : "off"} (${llmBackend}).`);
      billingStarter.textContent = starterParts.join(" ");

      const summary = formatPricingSummary(cfg?.pricing_model, spl);
      const details = formatPricingDetails(cfg?.pricing_model, spl);
      const detailLines = details
        ? `${details.breakdown.map((l) => `- ${l}`).join("\n")}\n\nExamples:\n${details.examples.map((l) => `- ${l}`).join("\n")}`
        : "";
      billingPricing.innerHTML = "";
      const summaryEl = document.createElement("div");
      summaryEl.textContent = summary;
      const toggleBtn = document.createElement("button");
      toggleBtn.type = "button";
      toggleBtn.className = "billingToggle";
      toggleBtn.textContent = "Show pricing details ▾";
      const detailEl = document.createElement("div");
      detailEl.className = "billingDetails";
      const detailPre = document.createElement("pre");
      detailPre.textContent = detailLines.trim();
      detailEl.appendChild(detailPre);
      toggleBtn.addEventListener("click", () => {
        const open = detailEl.style.display === "block";
        detailEl.style.display = open ? "none" : "block";
        toggleBtn.textContent = open ? "Show pricing details ▾" : "Hide pricing details ▴";
      });
      billingPricing.appendChild(summaryEl);
      billingPricing.appendChild(toggleBtn);
      billingPricing.appendChild(detailEl);
      billingPanel.style.display = "block";
      setBillingActions([cfg?.topup_url, cfg?.points_topup_url]);
    }

    function renderBillingStatus(status) {
      if (!billingBalance) return;
      const spl = tollTokenLabel();
      const pointsSymbol = String(status?.points_symbol || "PTS");
      const tokenBal = Number(status?.token_balance || 0);
      const pointsBal = Number(status?.points_balance || 0);
      const parts = [];
      parts.push(`On-chain ${spl}: ${tokenBal} (wallet balance).`);
      if (status?.points_enabled) parts.push(`${pointsBal} ${pointsSymbol} (internal).`);
      parts.push(`Toll Tokens are on-chain utility. PTS is internal and non-transferable.`);
      billingBalance.textContent = parts.join(" ");
      billingBalance.style.display = "block";
      setBillingActions([status?.topup_url, status?.points_topup_url]);
    }

    async function loadBillingConfig() {
      try {
        const r = await workerFetch("/billing/config", { method: "GET" });
        const data = await r.json();
        if (!r.ok || !data?.ok) return;
        renderBillingConfig(data);
      } catch {}
    }

    async function loadBillingStatus() {
      if (!sessionId) return;
      try {
        const r = await workerFetch(`/billing/status?session_id=${encodeURIComponent(sessionId)}`, { method: "GET" });
        const data = await r.json();
        if (!r.ok || !data?.ok) return;
        renderBillingStatus(data.billing || {});
      } catch {}
    }


    function escapeHtml(s) {
      return String(s)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function linkify(text) {
      const safe = escapeHtml(text);
      const urlRe = /(https?:\/\/[^\s)]+)|(\b([a-z0-9-]+\.)+[a-z]{2,}(\/[^\s)]*)?\b)/ig;
      return safe.replace(urlRe, (m) => {
        const href = m.startsWith("http") ? m : ("https://" + m);
        return `<a href="${href}" target="_blank" rel="noopener noreferrer">${m}</a>`;
      });
    }

    function addMsg(who, text) {
      const row = document.createElement("div");
      row.className = "msg " + who;

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.innerHTML = linkify(text);

      row.appendChild(bubble);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function openSite(url) {
      try { window.open(url, "_blank", "noopener,noreferrer"); } catch {}
    }

    function addDemoButton(demoUrl) {
      const a = document.createElement("a");
      a.href = demoUrl;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.textContent = "Open Example Site (new tab)";
      a.style.display = "inline-block";
      a.style.marginTop = "8px";
      a.style.padding = "10px 12px";
      a.style.border = "1px solid #ddd";
      a.style.borderRadius = "10px";
      a.style.textDecoration = "none";
      chat.appendChild(a);
      chat.scrollTop = chat.scrollHeight;
    }

    function addOpenLinkButton(url, label = "Open Link (new tab)") {
      const safe = String(url || "").trim();
      if (!safe) return;
      const a = document.createElement("a");
      a.href = safe;
      a.target = "_blank";
      a.rel = "noopener noreferrer";
      a.textContent = label;
      a.style.display = "inline-block";
      a.style.marginTop = "8px";
      a.style.padding = "10px 12px";
      a.style.border = "1px solid var(--btn-border)";
      a.style.borderRadius = "10px";
      a.style.textDecoration = "none";
      a.style.background = "#fff";
      chat.appendChild(a);
      chat.scrollTop = chat.scrollHeight;
    }

    function addColorSwatches(colors) {
      const list = Array.isArray(colors) ? colors : [];
      if (!list.length) return;

      const row = document.createElement("div");
      row.className = "msg ai";

      const wrap = document.createElement("div");
      wrap.className = "bubble";
      wrap.style.display = "inline-flex";
      wrap.style.gap = "10px";
      wrap.style.alignItems = "center";
      wrap.style.flexWrap = "wrap";
      wrap.style.maxWidth = "100%";

      for (const c of list.slice(0, 6)) {
        const chip = document.createElement("div");
        chip.style.display = "inline-flex";
        chip.style.alignItems = "center";
        chip.style.gap = "6px";
        chip.style.padding = "4px 7px";
        chip.style.border = "1px solid #c6d5e4";
        chip.style.borderRadius = "999px";
        chip.style.background = "#fff";
        const sw = document.createElement("div");
        sw.title = c;
        sw.style.width = "18px";
        sw.style.height = "18px";
        sw.style.borderRadius = "5px";
        sw.style.border = "1px solid #7f94aa";
        sw.style.background = c;
        const hex = document.createElement("span");
        hex.style.fontSize = "12px";
        hex.style.color = "var(--muted)";
        hex.textContent = c;
        chip.appendChild(sw);
        chip.appendChild(hex);
        wrap.appendChild(chip);
      }

      row.appendChild(wrap);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function addPaletteOptions(palettes) {
      const list = Array.isArray(palettes) ? palettes : [];
      if (!list.length) return;

      const row = document.createElement("div");
      row.className = "paletteRow";

      for (const p of list.slice(0, 3)) {
        const id = String(p?.id || "").trim().toUpperCase();
        const name = String(p?.name || "").trim();
        const desc = String(p?.description || "").trim();
        const colors = Array.isArray(p?.colors) ? p.colors.slice(0, 5) : [];

        const card = document.createElement("div");
        card.className = "paletteCard";

        const meta = document.createElement("div");
        meta.className = "paletteMeta";
        const tag = document.createElement("span");
        tag.className = "paletteTag";
        tag.textContent = id ? `Palette ${id}` : "Palette";
        meta.appendChild(tag);
        card.appendChild(meta);

        const title = document.createElement("div");
        title.className = "paletteTitle";
        title.textContent = name || "Brand Direction";
        card.appendChild(title);

        if (desc) {
          const hint = document.createElement("div");
          hint.className = "paletteHint";
          hint.textContent = desc;
          card.appendChild(hint);
        }

        const preview = document.createElement("div");
        preview.className = "palettePreview";
        if (colors.length) {
          preview.style.background = `linear-gradient(90deg, ${colors.join(", ")})`;
        }
        card.appendChild(preview);

        const swatches = document.createElement("div");
        swatches.className = "paletteSwatches";
        for (const color of colors) {
          const sw = document.createElement("div");
          sw.className = "paletteSwatch";
          const dot = document.createElement("div");
          dot.className = "paletteDot";
          dot.style.background = String(color || "#ddd");
          dot.title = String(color || "");
          const hex = document.createElement("span");
          hex.className = "paletteHex";
          hex.textContent = String(color || "").toUpperCase();
          sw.appendChild(dot);
          sw.appendChild(hex);
          swatches.appendChild(sw);
        }
        card.appendChild(swatches);

        const pickBtn = document.createElement("button");
        pickBtn.type = "button";
        pickBtn.className = "palettePickBtn";
        pickBtn.textContent = `Choose ${id || "this palette"}`;
        pickBtn.addEventListener("click", async () => {
          if (pendingRequest) return;
          for (const b of row.querySelectorAll(".palettePickBtn")) b.disabled = true;
          const answer = id || "palette";
          addMsg("me", answer);
          try {
            await callWorkerAnswer(answer);
          } catch {
            addMsg("ai", "Network/CORS error. Check DevTools console.");
            setRequestPending(false);
          } finally {
            for (const b of row.querySelectorAll(".palettePickBtn")) b.disabled = false;
          }
        });
        card.appendChild(pickBtn);
        row.appendChild(card);
      }

      if (!row.childElementCount) return;
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function addCtaActions(actions) {
      const list = Array.isArray(actions) ? actions : [];
      if (!list.length) return;
      const row = document.createElement("div");
      row.className = "ctaRow";

      for (const action of list.slice(0, 3)) {
        if (!action || !action.url) continue;
        const a = document.createElement("a");
        a.href = action.url;
        a.target = "_blank";
        a.rel = "noopener noreferrer";
        a.className = "ctaBtn" + (action.id === "connect_cloudflare" ? " primary" : "");
        a.textContent = action.label || "Open";
        row.appendChild(a);
      }

      if (!row.childElementCount) return;
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    function actionPriority(id) {
      const order = {
        install_ai_webadmin_plugin: 1,
        connect_cloudflare: 2,
        install_tolldns_required: 3,
        signup_github_backup: 4,
        migrate_hosting: 5,
        free_vps_bridge: 6,
        dual_server_upgrade: 7,
        pay_monthly_paypal: 8,
        pay_monthly_crypto: 9
      };
      return order[id] || 99;
    }

    function setActionBar(actions) {
      const list = (Array.isArray(actions) ? actions : [])
        .filter((a) => a && a.url)
        .slice()
        .sort((a, b) => actionPriority(a.id) - actionPriority(b.id))
        .slice(0, 4);
      actionBar.innerHTML = "";
      if (!list.length) {
        actionBar.style.display = "none";
        return;
      }
      for (const a of list) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "actionBtn" + (a.id === "install_ai_webadmin_plugin" ? " primary" : "");
        btn.textContent = a.label || "Open";
        btn.addEventListener("click", () => openSite(a.url));
        actionBar.appendChild(btn);
      }
      actionBar.style.display = "flex";
    }

    function addInlineActionButton(label, onClick) {
      const row = document.createElement("div");
      row.className = "ctaRow";
      const btn = document.createElement("button");
      btn.type = "button";
      btn.className = "ctaBtn primary";
      btn.textContent = label;
      btn.addEventListener("click", onClick);
      row.appendChild(btn);
      chat.appendChild(row);
      chat.scrollTop = chat.scrollHeight;
    }

    async function startOnchainClaim() {
      if (!sessionId || !walletSession || walletSession.protocol !== "solana") {
        addMsg("ai", "On-chain claim is only available for Solana wallets right now.");
        return;
      }
      try {
        const prep = await workerFetch("/wallet/claim/prepare", {
          method: "POST",
          headers: { "content-type": "application/json" },
          body: JSON.stringify({ session_id: sessionId }),
        });
        const prepData = await prep.json();
        if (!prep.ok || !prepData?.ok) {
          addMsg("ai", prepData?.error || "Could not prepare on-chain claim.");
          return;
        }
        if (prepData.already_claimed) {
          addMsg("ai", "On-chain claim already recorded for this wallet.");
          return;
        }
        const solanaWeb3 = await loadSolanaWeb3();
        if (!solanaWeb3) throw new Error("Solana web3 not available.");
        const provider = window.phantom?.solana || window.solana;
        if (!provider || !provider.isPhantom) throw new Error("Phantom Solana wallet was not detected.");
        const memoProgram = new solanaWeb3.PublicKey(prepData.memo_program);
        const memoData = new TextEncoder().encode(String(prepData.memo || ""));
        const memoIx = new solanaWeb3.TransactionInstruction({
          keys: [],
          programId: memoProgram,
          data: memoData,
        });
        const tx = new solanaWeb3.Transaction().add(memoIx);
        const recentBlockhash = String(prepData.recent_blockhash || "").trim();
        if (!recentBlockhash) throw new Error("Claim preparation failed: missing recent blockhash.");
        tx.recentBlockhash = recentBlockhash;
        const lastValid = Number(prepData.last_valid_block_height || 0);
        if (Number.isFinite(lastValid) && lastValid > 0) tx.lastValidBlockHeight = lastValid;
        tx.feePayer = new solanaWeb3.PublicKey(walletSession.address);
        const signed = await provider.signAndSendTransaction(tx, { preflightCommitment: "confirmed" });
        const signature = String(signed?.signature || signed);
        if (!signature) throw new Error("No signature returned from wallet.");
        let confirmData = null;
        let confirmed = false;
        for (let i = 0; i < 6; i++) {
          const confirm = await workerFetch("/wallet/claim/confirm", {
            method: "POST",
            headers: { "content-type": "application/json" },
            body: JSON.stringify({ session_id: sessionId, txid: signature }),
          });
          const data = await confirm.json();
          confirmData = data;
          if (confirm.ok && data?.ok) {
            confirmed = true;
            break;
          }
          await new Promise((resolve) => setTimeout(resolve, 1200));
        }
        if (!confirmed || !confirmData?.ok) {
          addMsg("ai", confirmData?.error || "Could not confirm on-chain claim right now.");
          addMsg("ai", "Your Toll Tokens are already available; claim is optional and does not affect your starter balance.");
          return;
        }
        addMsg("ai", `On-chain claim recorded. Tx: ${confirmData.txid}`);
        if (confirmData.reward) {
          if (confirmData.reward.ok && confirmData.reward.txid) {
            addMsg("ai", `Reward mint submitted. Tx: ${confirmData.reward.txid}`);
          } else if (confirmData.reward.skipped) {
            addMsg("ai", "Reward mint skipped (not configured yet).");
          } else if (confirmData.reward.error) {
            addMsg("ai", `Reward mint failed: ${confirmData.reward.error}`);
          }
        }
      } catch (error) {
        const msg = String(error?.message || "On-chain claim failed.");
        addMsg("ai", msg);
        addMsg("ai", "Your Toll Tokens are already available; claim is optional and does not affect your starter balance.");
      }
    }

    function shouldShowYesNoButtons(aiText) {
      const t = String(aiText || "").toLowerCase();
      const patterns = [
        "is that correct",
        "is that your website",
        "want me to do that",
        "want me to run the scan",
        "would you be willing",
        "would you like me to build",
        "overall happy",
      ];
      if (patterns.some(p => t.includes(p))) return true;
      if (t.includes("?") && (t.includes("would you") || t.includes("is that") || t.includes("want"))) return true;
      return false;
    }

    function setYesNoUI(on) {
      quickBar.style.display = on ? "flex" : "none";
    }

    function setSmartOptions(aiText, payload = null) {
      const t = String(aiText || "").toLowerCase();
      const options = [];
      const paletteOptions = Array.isArray(payload?.palette_options) ? payload.palette_options : [];

      if (paletteOptions.length) {
        for (const p of paletteOptions.slice(0, 3)) {
          const id = String(p?.id || "").trim().toUpperCase();
          const name = String(p?.name || "").trim();
          if (!id) continue;
          options.push({ label: `Palette ${id}${name ? ` (${name})` : ""}`, value: id });
        }
      }

      if (t.includes('reply "opened"') || t.includes("when you're ready, open this link")) {
        options.push({ label: "Opened", value: "opened" });
        options.push({ label: "Different site", value: "different site" });
      }
      if (t.includes("(modern / bold)")) {
        options.push({ label: "Modern", value: "modern" });
        options.push({ label: "Bold", value: "bold" });
        options.push({ label: "Not sure", value: "not sure" });
      }
      if (t.includes("too bright / too dark / just right")) {
        options.push({ label: "Too bright", value: "too bright" });
        options.push({ label: "Too dark", value: "too dark" });
        options.push({ label: "Just right", value: "just right" });
      }
      if (t.includes("easy to read / cluttered / too empty")) {
        options.push({ label: "Easy to read", value: "easy to read" });
        options.push({ label: "Cluttered", value: "cluttered" });
        options.push({ label: "Too empty", value: "too empty" });
      }

      const numberedMatches = [...String(aiText || "").matchAll(/\b([1-3])\)\s+([^\n]+)/g)];
      if (numberedMatches.length >= 2) {
        for (const m of numberedMatches.slice(0, 3)) {
          options.push({ label: `${m[1]}) ${String(m[2]).trim().slice(0, 24)}`, value: m[1] });
        }
      }

      const seen = new Set();
      const deduped = options.filter((o) => {
        const key = `${o.label}|${o.value}`;
        if (seen.has(key)) return false;
        seen.add(key);
        return true;
      }).slice(0, 6);

      smartBar.innerHTML = "";
      if (!deduped.length) {
        smartBar.style.display = "none";
        return;
      }

      for (const opt of deduped) {
        const b = document.createElement("button");
        b.type = "button";
        b.className = "smartBtn";
        b.textContent = opt.label;
        b.addEventListener("click", async () => {
          if (pendingRequest) return;
          addMsg("me", opt.value);
          try {
            await callWorkerAnswer(opt.value);
          } catch {
            addMsg("ai", "Network/CORS error. Check DevTools console.");
            setRequestPending(false);
          }
        });
        smartBar.appendChild(b);
      }
      smartBar.style.display = "flex";
    }

    function setRequestPending(isPending) {
      pendingRequest = isPending;
      input.disabled = isPending || !sessionId;
      sendBtn.disabled = isPending || !sessionId;
      btnYes.disabled = isPending;
      btnNo.disabled = isPending;
      const smartButtons = smartBar.querySelectorAll("button");
      for (const b of smartButtons) b.disabled = isPending;
      const actionButtons = actionBar.querySelectorAll("button");
      for (const b of actionButtons) b.disabled = isPending;
    }

    async function loadSecurityConfig() {
      try {
        const r = await workerFetch("/security/config", { method: "GET" });
        const data = await r.json();
        if (r.ok && data && data.ok) {
          securityConfig = {
            turnstile_required: Boolean(data.turnstile_required),
            turnstile_site_key: data.turnstile_site_key || null,
            wallet_login_enabled: data.wallet_login_enabled !== false,
            walletconnect_project_id: data.walletconnect_project_id || null,
          };
        }
      } catch {}
      return securityConfig;
    }

    function loadTurnstileScript() {
      if (window.turnstile) return Promise.resolve();
      if (turnstileScriptPromise) return turnstileScriptPromise;
      turnstileScriptPromise = new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "https://challenges.cloudflare.com/turnstile/v0/api.js?render=explicit";
        s.async = true;
        s.defer = true;
        s.onload = () => resolve();
        s.onerror = () => reject(new Error("Could not load security challenge."));
        document.head.appendChild(s);
      });
      return turnstileScriptPromise;
    }

    function handleTurnstileSuccess(token) {
      if (turnstileResolve) turnstileResolve(String(token || ""));
    }
    function handleTurnstileError() {
      if (turnstileReject) turnstileReject(new Error("Security challenge failed."));
    }

    async function ensureTurnstileToken() {
      if (!securityConfig.turnstile_required) return null;
      if (!securityConfig.turnstile_site_key) throw new Error("Security challenge is not configured.");
      await loadTurnstileScript();
      const mount = document.getElementById("turnstileMount");
      if (!window.turnstile || !mount) throw new Error("Security challenge unavailable.");

      if (turnstileWidgetId === null) {
        turnstileWidgetId = window.turnstile.render(mount, {
          sitekey: securityConfig.turnstile_site_key,
          size: "invisible",
          callback: handleTurnstileSuccess,
          "error-callback": handleTurnstileError,
          "expired-callback": handleTurnstileError,
          action: "start",
        });
      }

      return await new Promise((resolve, reject) => {
        let done = false;
        const finish = (fn, value) => {
          if (done) return;
          done = true;
          turnstileResolve = null;
          turnstileReject = null;
          clearTimeout(timeout);
          fn(value);
        };
        const timeout = setTimeout(() => finish(reject, new Error("Security challenge timed out.")), 15000);
        turnstileResolve = (token) => finish(resolve, token);
        turnstileReject = (error) => finish(reject, error || new Error("Security challenge failed."));
        try {
          window.turnstile.reset(turnstileWidgetId);
          window.turnstile.execute(turnstileWidgetId);
        } catch (error) {
          finish(reject, error);
        }
      });
    }

    function setStartHint(text, isError = false) {
      if (!startHint) return;
      startHint.textContent = String(text || "");
      startHint.style.color = isError ? "#9d1c1c" : "var(--muted)";
    }

    function setStartButtonsDisabled(disabled) {
      const buttons = [startNameBtn, walletMetaMaskBtn, walletConnectBtn, walletLedgerBtn, walletPhantomBtn];
      for (const b of buttons) {
        if (b) b.disabled = Boolean(disabled);
      }
    }

    function bytesToBase64(bytes) {
      const arr = bytes instanceof Uint8Array ? bytes : new Uint8Array(bytes || []);
      let s = "";
      for (let i = 0; i < arr.length; i += 1) s += String.fromCharCode(arr[i]);
      return btoa(s);
    }

    async function fetchWalletChallenge(provider, protocol) {
      const q = new URLSearchParams({ provider: String(provider || ""), protocol: String(protocol || "evm") });
      const r = await workerFetch(`/auth/wallet/challenge?${q.toString()}`, { method: "GET" });
      const data = await r.json();
      if (!r.ok || !data?.ok) {
        throw new Error(String(data?.error || "Could not create wallet challenge."));
      }
      return data;
    }

    async function loadWalletConnectScript() {
      if (window.WalletConnectEthereumProvider) return;
      if (!walletConnectScriptPromise) {
        walletConnectScriptPromise = new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = "https://unpkg.com/@walletconnect/ethereum-provider@2.21.1/dist/index.umd.js";
          s.async = true;
          s.defer = true;
          s.onload = () => resolve();
          s.onerror = () => reject(new Error("Could not load WalletConnect."));
          document.head.appendChild(s);
        });
      }
      await walletConnectScriptPromise;
    }

    async function getWalletConnectProvider() {
      const projectId = String(securityConfig.walletconnect_project_id || "").trim();
      if (!projectId) throw new Error("WalletConnect is not configured yet.");
      await loadWalletConnectScript();
      if (!window.WalletConnectEthereumProvider?.init) throw new Error("WalletConnect provider unavailable.");
      if (!walletConnectProvider) {
        walletConnectProvider = await window.WalletConnectEthereumProvider.init({
          projectId,
          chains: [1],
          optionalChains: [10, 56, 137, 8453, 42161, 43114],
          showQrModal: true,
          methods: ["personal_sign", "eth_sign", "eth_sendTransaction"],
          optionalMethods: ["wallet_switchEthereumChain", "eth_chainId"],
          optionalEvents: ["chainChanged", "accountsChanged"],
        });
      }
      return walletConnectProvider;
    }

    async function signWithEvmProvider(provider, address, message) {
      try {
        return await provider.request({ method: "personal_sign", params: [message, address] });
      } catch {
        return await provider.request({ method: "eth_sign", params: [address, message] });
      }
    }

    function pickMetaMaskProvider() {
      const eth = window.ethereum;
      if (!eth) return null;
      if (Array.isArray(eth.providers) && eth.providers.length) {
        return eth.providers.find((p) => p && p.isMetaMask) || eth.providers[0];
      }
      return eth;
    }

    async function connectEvmWallet(providerName) {
      let provider = null;
      if (providerName === "metamask") {
        provider = pickMetaMaskProvider();
        if (!provider) throw new Error("MetaMask was not detected.");
      } else if (providerName === "phantom") {
        provider = window.phantom?.ethereum || null;
        if (!provider) throw new Error("Phantom EVM wallet was not detected.");
      } else if (providerName === "walletconnect" || providerName === "ledger") {
        provider = await getWalletConnectProvider();
      } else {
        throw new Error("Unsupported EVM wallet.");
      }

      const challenge = await fetchWalletChallenge(providerName, "evm");
      const accounts = await provider.request({ method: "eth_requestAccounts" });
      const address = Array.isArray(accounts) ? String(accounts[0] || "") : "";
      if (!address) throw new Error("No wallet account was returned.");
      const chainId = await provider.request({ method: "eth_chainId" });
      const signature = await signWithEvmProvider(provider, address, challenge.message);
      return {
        provider: providerName,
        protocol: "evm",
        address,
        chain_id: chainId,
        nonce: challenge.nonce,
        message: challenge.message,
        signature,
      };
    }

    async function connectPhantomSolana() {
      const provider = window.phantom?.solana || window.solana;
      if (!provider || !provider.isPhantom) throw new Error("Phantom Solana wallet was not detected.");
      const challenge = await fetchWalletChallenge("phantom", "solana");
      await provider.connect();
      const encoded = new TextEncoder().encode(challenge.message);
      const signed = await provider.signMessage(encoded, "utf8");
      const address = String(signed?.publicKey?.toString?.() || provider?.publicKey?.toString?.() || "");
      const signatureBytes = signed?.signature instanceof Uint8Array ? signed.signature : new Uint8Array(signed?.signature || []);
      if (!address || !signatureBytes.length) throw new Error("Phantom did not return a valid signature.");
      return {
        provider: "phantom",
        protocol: "solana",
        address,
        chain_id: "solana:mainnet-beta",
        nonce: challenge.nonce,
        message: challenge.message,
        signature: bytesToBase64(signatureBytes),
      };
    }

    let solanaWeb3ScriptPromise = null;
    async function loadSolanaWeb3() {
      if (window.solanaWeb3) return window.solanaWeb3;
      if (!solanaWeb3ScriptPromise) {
        solanaWeb3ScriptPromise = new Promise((resolve, reject) => {
          const s = document.createElement("script");
          s.src = "https://unpkg.com/@solana/web3.js@1.95.4/lib/index.iife.min.js";
          s.async = true;
          s.onload = () => resolve(window.solanaWeb3);
          s.onerror = () => reject(new Error("Failed to load Solana web3."));
          document.head.appendChild(s);
        });
      }
      return solanaWeb3ScriptPromise;
    }

    async function startSession(payload) {
      await loadSecurityConfig();
      let turnstileToken = null;
      try {
        turnstileToken = await ensureTurnstileToken();
      } catch {
        throw new Error("Security check failed. Please refresh and try again.");
      }

      const r = await workerFetch("/q1/start", {
        method: "POST",
        headers: { "content-type": "application/json" },
        body: JSON.stringify({
          ...payload,
          turnstile_token: turnstileToken,
          ui_theme_mode: currentThemeMode,
          wallet_extension_detected: detectWalletExtensionPresence(),
        }),
      });
      const data = await r.json();
      if (!r.ok || !data?.ok) throw new Error(String(data?.error || "Could not start chat."));
      sessionId = data.session_id;
      state = data.next_state;
      if (startPanel) startPanel.style.display = "none";
      input.disabled = false;
      sendBtn.disabled = false;
      addMsg("ai", data.prompt);
      if (data.billing) {
        renderBillingConfig(data.billing);
        renderBillingStatus(data.billing);
        const spl = tollTokenLabel();
        const pts = data.billing.points_symbol || "PTS";
        addMsg(
          "ai",
          `On-chain ${spl}: ${Number(data.billing.token_balance || 0)} (wallet balance). ` +
            `${data.billing.points_enabled ? `${Number(data.billing.points_balance || 0)} ${pts} (internal). ` : ""}` +
            "Toll Tokens are on-chain utility. PTS is internal and non-transferable."
        );
        if (data.billing.pricing_model) {
          addMsg("ai", formatPricingSummary(data.billing.pricing_model, spl));
        }
        if (walletSession?.protocol === "solana" && !data.billing.onchain_claimed && !onchainClaimShown) {
          onchainClaimShown = true;
          addMsg(
            "ai",
            "Optional: record a one-time on-chain claim (memo-only transaction) for future rewards. This is not required to use your Toll Tokens."
          );
          addInlineActionButton("Record On-chain Claim", startOnchainClaim);
        }
      }
      await loadBillingStatus();
      setYesNoUI(shouldShowYesNoButtons(data.prompt));
      setSmartOptions(data.prompt, data);
      input.focus();
    }

    async function callWorkerAnswer(text) {
      if (pendingRequest) return;
      setRequestPending(true);
      try {
        const r = await workerFetch("/q1/answer", {
          method: "POST",
          headers: {"content-type":"application/json"},
          body: JSON.stringify({ session_id: sessionId, state, answer: text })
        });

        const data = await r.json();
        if (!data.ok) {
          if (data.code === "SECURITY_VERIFICATION_REQUIRED") {
            addMsg("ai", "Security verification expired. Please refresh to restart securely.");
          } else {
            addMsg("ai", "Error: " + (data.error || "unknown"));
          }
          return;
        }

        state = data.next_state;

        if (data.open_url) {
          openSite(data.open_url);
          addOpenLinkButton(data.open_url, "Open Suggested Link (new tab)");
        }

        addMsg("ai", data.prompt);

        if (data.demo_url) {
          addDemoButton(data.demo_url);
        }

        if (data.color_swatches) {
          addColorSwatches(data.color_swatches);
        }

        if (Array.isArray(data.cta_actions) && data.cta_actions.length) {
          addCtaActions(data.cta_actions);
          setActionBar(data.cta_actions);
        } else if (Array.isArray(data.plugin_step_actions) && data.plugin_step_actions.length) {
          const pluginActions = data.plugin_step_actions.map((s) => ({
            id: s.id,
            url: s.url,
            label: `${s.step}) ${s.label}`
          }));
          addCtaActions(pluginActions);
          setActionBar(pluginActions);
        }

        setYesNoUI(shouldShowYesNoButtons(data.prompt));
        setSmartOptions(data.prompt, data);

        if (Array.isArray(data.palette_options) && data.palette_options.length) {
          addPaletteOptions(data.palette_options);
        }

        if (autoAdvanceTimer) {
          clearTimeout(autoAdvanceTimer);
          autoAdvanceTimer = null;
        }

        if (data.auto_advance_after_seconds && data.auto_advance_answer) {
          const secs = Number(data.auto_advance_after_seconds);
          if (Number.isFinite(secs) && secs > 0) {
            autoAdvanceTimer = setTimeout(async () => {
              try {
                if (pendingRequest) return;
                await callWorkerAnswer(String(data.auto_advance_answer));
              } catch {
                addMsg("ai", "I could not auto-continue. Reply when you are ready.");
              }
            }, secs * 1000);
          }
        }
      } finally {
        setRequestPending(false);
      }
    }

    btnYes.addEventListener("click", async () => {
      if (pendingRequest) return;
      addMsg("me", "yes");
      try {
        await callWorkerAnswer("yes");
      } catch {
        addMsg("ai", "Network/CORS error. Check DevTools console.");
        setRequestPending(false);
      }
    });
    btnNo.addEventListener("click", async () => {
      if (pendingRequest) return;
      addMsg("me", "no");
      try {
        await callWorkerAnswer("no");
      } catch {
        addMsg("ai", "Network/CORS error. Check DevTools console.");
        setRequestPending(false);
      }
    });

    async function startWithName() {
      const firstName = (prompt("First Name?") || "").trim();
      const lastName = (prompt("Last Name?") || "").trim();
      if (!firstName || !lastName) {
        setStartHint("Please enter both first and last name to continue.", true);
        return;
      }
      await startSession({ FirstName: firstName, LastName: lastName, login_method: "name" });
    }

    async function startWithWallet(providerName) {
      const provider = String(providerName || "").toLowerCase();
      if (!provider) return;

      let walletAuth = null;
      if (provider === "metamask") {
        walletAuth = await connectEvmWallet("metamask");
      } else if (provider === "walletconnect") {
        walletAuth = await connectEvmWallet("walletconnect");
      } else if (provider === "ledger") {
        walletAuth = await connectEvmWallet("ledger");
      } else if (provider === "phantom") {
        if (window.phantom?.solana || window.solana?.isPhantom) {
          walletAuth = await connectPhantomSolana();
        } else {
          walletAuth = await connectEvmWallet("phantom");
        }
      } else {
        throw new Error("Unsupported wallet option.");
      }

      walletSession = walletAuth;
      await startSession({ login_method: "wallet", wallet_auth: walletAuth });
    }

    async function handleStartAction(action) {
      if (pendingRequest) return;
      setRequestPending(true);
      setStartButtonsDisabled(true);
      setStartHint("Connecting…");
      try {
        if (action === "name") {
          await startWithName();
        } else {
          await startWithWallet(action);
        }
        setStartHint("Connected.");
      } catch (error) {
        setStartHint(String(error?.message || "Start failed. Please try again."), true);
      } finally {
        setRequestPending(false);
        if (!sessionId) setStartButtonsDisabled(false);
      }
    }

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;

      if (!sessionId || !state) {
        addMsg("ai", "Session not started yet. Refresh the page to begin.");
        return;
      }

      input.value = "";
      addMsg("me", text);

      try {
        await callWorkerAnswer(text);
      } catch {
        addMsg("ai", "Network/CORS error. Check DevTools console.");
        setRequestPending(false);
      }
    });

    startNameBtn.addEventListener("click", () => handleStartAction("name"));
    walletMetaMaskBtn.addEventListener("click", () => handleStartAction("metamask"));
    walletConnectBtn.addEventListener("click", () => handleStartAction("walletconnect"));
    walletLedgerBtn.addEventListener("click", () => handleStartAction("ledger"));
    walletPhantomBtn.addEventListener("click", () => handleStartAction("phantom"));

    resolveInitialTheme();

    loadSecurityConfig().then((cfg) => {
      if (!cfg.walletconnect_project_id) {
        walletConnectBtn.title = "WalletConnect project id is not configured yet.";
        walletLedgerBtn.title = "WalletConnect project id is not configured yet.";
      }
    });

    loadBillingConfig();
  </script>
</body>
</html>
