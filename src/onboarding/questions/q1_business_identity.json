{
  "id": "q1_business_identity",
  "version": 1,
  "title": "Business identity & category confirmation",
  "independent_vars": {
    "one_sentence": null,
    "category_guess": null,
    "category_confirmed_by_user": null,
    "declared_business_type_raw": null,
    "declared_business_type_definition_user": null,
    "reference_site_url": null,
    "business_name": null,
    "business_city_state": null,
    "business_website_user_provided": null,
    "verification_confirmed_by_user": null
  },
  "dependent_vars": {
    "business_type_final": null,
    "business_type_definition_final": null,
    "business_name_final": null,
    "verification": {
      "candidate_url": null,
      "summary": null,
      "source": null
    }
  },
  "lookups": {
    "ddg_instant_answer": {
      "enabled": true,
      "endpoint": "https://api.duckduckgo.com/",
      "notes": "Instant Answer API returns topic summaries/official site-like fields when available; not a full search results API."
    },
    "mediawiki_opensearch": {
      "enabled": true,
      "endpoint": "https://en.wikipedia.org/w/api.php",
      "params": {
        "action": "opensearch",
        "format": "json"
      }
    }
  },
  "states": [
    {
      "state": "Q1A_ONE_SENTENCE",
      "prompt": "If you could describe your business in one sentence, what would that sentence be?",
      "input": { "type": "text", "store_to": "independent_vars.one_sentence" },
      "next": "Q1B_CONFIRM_GUESSED_CATEGORY"
    },
    {
      "state": "Q1B_CONFIRM_GUESSED_CATEGORY",
      "action": {
        "type": "derive",
        "derive_to": "independent_vars.category_guess",
        "from": "independent_vars.one_sentence",
        "notes": "Derive a best-guess category label (e.g., restaurant, plumber, barber, agency)."
      },
      "prompt": "Are you a {independent_vars.category_guess} business?",
      "input": { "type": "yes_no", "store_to": "independent_vars.category_confirmed_by_user" },
      "branches": [
        { "when": "yes", "next": "Q1C_BUSINESS_NAME" },
        { "when": "no", "next": "Q1B_NO_ASK_TYPE" }
      ]
    },
    {
      "state": "Q1B_NO_ASK_TYPE",
      "prompt": "Well what type of business is it then?",
      "input": { "type": "text", "store_to": "independent_vars.declared_business_type_raw" },
      "next": "LOOKUP_TYPE_DEFINITION"
    },
    {
      "state": "LOOKUP_TYPE_DEFINITION",
      "action": {
        "type": "lookup",
        "lookups": [
          {
            "provider": "mediawiki_opensearch",
            "query_template": "{independent_vars.declared_business_type_raw}",
            "result_map": {
              "top_title": "dependent_vars.business_type_final",
              "top_result_url": "dependent_vars.verification.candidate_url"
            }
          },
          {
            "provider": "ddg_instant_answer",
            "query_template": "{independent_vars.declared_business_type_raw}",
            "result_map": {
              "abstract": "dependent_vars.business_type_definition_final",
              "abstract_source": "dependent_vars.verification.source"
            }
          }
        ],
        "notes": "Use the lookups to produce a short definition for the declared business type."
      },
      "next": "Q1B_NO_CONFIRM_TYPE_DEFINITION"
    },
    {
      "state": "Q1B_NO_CONFIRM_TYPE_DEFINITION",
      "prompt": "So your business does {dependent_vars.business_type_definition_final} — is that accurate?",
      "input": { "type": "yes_no", "store_to": "independent_vars.category_confirmed_by_user" },
      "branches": [
        { "when": "yes", "next": "Q1C_BUSINESS_NAME" },
        { "when": "no", "next": "Q1B_NO_ASK_USER_DEFINITION" }
      ]
    },
    {
      "state": "Q1B_NO_ASK_USER_DEFINITION",
      "prompt": "Can you please tell me what {independent_vars.declared_business_type_raw} does?",
      "input": { "type": "text", "store_to": "independent_vars.declared_business_type_definition_user" },
      "next": "Q1B_NO_RECONCILE_USER_DEFINITION"
    },
    {
      "state": "Q1B_NO_RECONCILE_USER_DEFINITION",
      "action": {
        "type": "derive",
        "derive_to": "dependent_vars.business_type_definition_final",
        "from": "independent_vars.declared_business_type_definition_user",
        "notes": "Use the user's definition as the canonical definition if lookups were inaccurate."
      },
      "prompt": "Based on what you said, I’m going to treat your business type as: {independent_vars.declared_business_type_raw}. Is that correct?",
      "input": { "type": "yes_no", "store_to": "independent_vars.category_confirmed_by_user" },
      "branches": [
        { "when": "yes", "next": "Q1C_BUSINESS_NAME" },
        { "when": "no", "next": "Q1B_NO_REFERENCE_SITE" }
      ]
    },
    {
      "state": "Q1B_NO_REFERENCE_SITE",
      "prompt": "I’m not finding reliable information on that type. Can you share a website of another business that does the same thing, so I can match the category correctly?",
      "input": { "type": "url_optional", "store_to": "independent_vars.reference_site_url" },
      "next": "Q1C_BUSINESS_NAME"
    },
    {
      "state": "Q1C_BUSINESS_NAME",
      "prompt": "What is the name of your business?",
      "input": { "type": "text", "store_to": "independent_vars.business_name" },
      "next": "Q1D_VERIFY_BUSINESS_LOOKUP"
    },
    {
      "state": "Q1D_VERIFY_BUSINESS_LOOKUP",
      "action": {
        "type": "lookup",
        "lookups": [
          {
            "provider": "ddg_instant_answer",
            "query_template": "{independent_vars.business_name} {independent_vars.business_city_state}",
            "result_map": {
              "abstract": "dependent_vars.verification.summary",
              "abstract_source": "dependent_vars.verification.source",
              "first_url": "dependent_vars.verification.candidate_url"
            }
          }
        ],
        "notes": "Identity verification: attempt to find summary/official link candidates. Not full SERPs."
      },
      "prompt": "I found this for {independent_vars.business_name}: Website: {dependent_vars.verification.candidate_url} — Summary: {dependent_vars.verification.summary}. Is this the right business?",
      "input": { "type": "yes_no", "store_to": "independent_vars.verification_confirmed_by_user" },
      "branches": [
        { "when": "yes", "next": "Q1_DONE" },
        { "when": "no", "next": "Q1D_ASK_FOR_WEBSITE_OR_CITY" }
      ]
    },
    {
      "state": "Q1D_ASK_FOR_WEBSITE_OR_CITY",
      "prompt": "Can you paste your website URL (if you have one), or tell me the city and state the business is in?",
      "input": {
        "type": "text_or_url",
        "store_to": [
          "independent_vars.business_website_user_provided",
          "independent_vars.business_city_state"
        ]
      },
      "next": "Q1_DONE"
    },
    {
      "state": "Q1_DONE",
      "action": {
        "type": "finalize",
        "assign": [
          { "to": "dependent_vars.business_name_final", "from": "independent_vars.business_name" },
          {
            "to": "dependent_vars.business_type_final",
            "from_priority": [
              "independent_vars.category_guess",
              "independent_vars.declared_business_type_raw"
            ]
          }
        ],
        "notes": "Finalize confirmed business_name and business_type for downstream onboarding."
      },
      "end": true
    }
  ]
}
